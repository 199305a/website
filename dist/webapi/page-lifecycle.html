<!DOCTYPE html><html prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Page Lifecycle API - Web API 教程 - 网道</title><!-- link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" --><link rel="stylesheet" href="assets/css/app.min.css"><link rel="stylesheet" href="https://apps.bdimg.com/libs/fontawesome/4.4.0/css/font-awesome.css"><!-- link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css"--><!-- link rel="stylesheet" href="assets/css/share.min.css" --><meta property="og:type" content="article"><meta property="og:title" content="Page Lifecycle API"><link rel="apple-touch-icon" sizes="57x57" href="assets/icons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="assets/icons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="assets/icons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="assets/icons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="assets/icons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="assets/icons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="assets/icons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="assets/icons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="assets/icons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="assets/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="assets/icons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="assets/icons/favicon-16x16.png"><link rel="manifest" href="assets/icons/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="assets/icons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"></head><body><nav class="navbar is-light" role="navigation" id="navbar" aria-label="main navigation"><div class="container"><div class="navbar-brand"><a href="index.html" class="navbar-item title has-text-grey has-text-weight-light is-5">网道 / WangDoc.com</a></div><div class="navbar-menu"><div class="navbar-end"><a class="navbar-item is-hidden-desktop-only" target="_blank" href="https://github.com/wangdoc/webapi-tutorial"><span class="icon" style="color: #333;"><i class="fa fa-lg fa-github"></i></span></a></div></div></div></nav><section class="section main article"><div class="container"><div class="columns"><div class="column is-8"><nav class="breadcrumb is-size-5-desktop" aria-label="breadcrumbs"><ul><li><a href="index.html"><span class="icon"><i class="fa fa-home"></i></span> &nbsp;Web API 教程</a></li><li class="is-active"><a class="has-text-grey" href="page-lifecycle.html">Page Lifecycle API</a></li></ul></nav><nav class="level level-previous-next is-size-5 is-mobile"><!-- Left side --><div class="level-left"><p class="level-item is-narrow"><a href="intl-relativetimeformat.html"><span class="icon"><i class="fa fa-toggle-left"></i></span> Intl.RelativeTimeFormat</a></p></div><div class="level-right"><p class="level-item is-narrow"><a href="server-sent-events.html">Server-Sent Events <span class="icon"><i class="fa fa-toggle-right"></i></span></a></p></div></nav><article class="content is-size-5-desktop"><h1 class="title">Page Lifecycle API</h1><div class="page-meta"><p>网道（WangDoc.com），互联网文档计划</p></div><p>Android、iOS 和最新的 Windows 系统上，操作系统可以随时启动和停止应用程序。系统资源不足的时候，这样可以释放资源，提高系统性能。</p><p>虽然，浏览器对网页提供一些生命周期相关事件（比如<code>load</code>、<code>unload</code>和<code>visibilitychange</code>），但是缺乏系统性的 API，而且没有考虑操作系统主动杀死进程的情况。</p><p>新的 Page Lifecycle API 尝试解决这个问题。</p><ul><li>标准化网页的生命周期状态的概念。</li><li>定义新的系统启动状态，允许浏览器限制隐藏或非活动选项卡。</li><li>创建新的 API 和事件，允许开发者响应这些状态的转换。</li></ul><p>有了这个 API，开发者就可以预测网页下一步的状态，从而进行各种针对性的处理。Chrome 68 支持这个 API，对于老式浏览器可以使用谷歌开发的兼容库 <a href="https://github.com/GoogleChromeLabs/page-lifecycle" target="_blank" rel="noopener">PageLifecycle.js</a>。</p><h2 id="简介">简介 <a class="markdownIt-Anchor" href="#简介">#</a></h2><p>网页的生命周期分成不同的阶段，每个时刻只可能处于某一个阶段。</p><ul><li>Active：网页可见，且处于输入焦点。</li><li>Passive：网页可见，但没有处于输入焦点。UI 更新和动画仍然在执行。</li><li>Hidden：网页不可见，当尚未冻结。</li><li>Frozen：网页冻结，定时器和回调函数不会执行，不过正在运行的任务会执行完。</li><li>Terminated：网页开始被浏览器卸载并从内存中清除，一般由用户手动触发。任何新任务都不可以在此状态下启动，并且如果运行时间太长，正在进行的任务可能会被终止。</li><li>Discarded：浏览器卸载网页，一般是在用户没有介入的情况下，由浏览器或操作系统强制执行。任何类型的新任务或 JavaScript 代码，都不能在此状态下运行，因为这时通常处在在资源限制的状况下，无法启动新进程。</li></ul><p>跟上面这些阶段相配合的，还有一系列事件。</p><ul><li>focus 事件：页面获得焦点，将从 Passive 状态变为 Active 状态。</li><li>blur 事件：页面失去焦点，将从 Active 状态变为 Passive 状态。</li><li>visibilitychange 事件：用户前往前页面、切换选项卡、关闭选项卡、最小化或关闭浏览器时，都会发生该时间。经过这个事件，网页可能处于 Passive 和 Hidden 状态。</li><li>freeze 事件：网页被冻结，可能从 Hidden 状态变为 Frozen 状态。</li><li>resume 时间：网页从冻结状态恢复，可能从 Froze 状态变为 Active / Passive / Hidden 状态。</li><li>pageshow 事件：用户加载网页时触发，可能是全新的页面加载，也可能是从缓存中获取的页面，跟网页是否可见无关。如果是从缓存中获取，则该事件的<code>persisted</code>属性为<code>true</code>，否则为<code>false</code>。</li><li>pagehide 事件：用户离开当前网页，进入另一个网页时触发，跟网页是否可见无关。如果浏览器能够将当前页面添加到缓存以供稍后重用，则事件的<code>persisted</code>属性为<code>true</code>。 如果为<code>true</code>，则页面进入 Frozen 状态，否则进入 Terminatied 状态。</li><li>beforeunload 事件：窗口，文档即将卸载时触发。该事件发生时，文档仍然可见，此时事件仍可取消。经过这个事件，网页进入 Terminated 状态。</li><li>unload 事件：页面正在卸载时触发。经过这个事件，网页进入 Terminated 状态。</li></ul><p>状态和事件有下面几种可能的搭配。</p><ul><li>Active 状态 + blur 事件 = Passive 状态</li><li>Passive 状态 + focus 事件 = Active 状态</li><li>Passive 状态 + visibilitychange 事件 = Hidden 状态</li><li>Hidden 状态 + visibilitychange 事件 = Passive 状态</li><li>Hidden 状态 + freezen 事件 = Frozen 状态</li><li>Hidden 状态 + pagehide 事件 = Terminated 状态</li><li>Frozen 状态 + resume 事件 = Active 状态 / Passive 状态 / Hidden 状态</li></ul><p>如果网页处于 Active、Passive 或 Hidden 阶段，可以通过下面的代码，获得网页当前的状态。</p><pre class="hljs"><code><span class="hljs-keyword">const</span> getState = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.visibilityState === <span class="hljs-string">'hidden'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'hidden'</span>;
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.hasFocus()) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'active'</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">'passive'</span>;
};
</code></pre><p>如果网页处于 Frozen 和 Terminated 状态，由于定时器代码不会执行，只能在事件监听时（监听 freeze 事件 和 pagehide 事件）判断状态。</p><p>如果网页处于 Discarded 状态，可以通过<code>document.wasDiscarded</code>属性判断（见下文）。</p><h2 id="frozen-状态的监听">Frozen 状态的监听 <a class="markdownIt-Anchor" href="#frozen-状态的监听">#</a></h2><p>这个 API 出现之前，开发者无法知道浏览器何时冻结网页（即 Frozen 状态）。现在，通过监听<code>freeze</code>事件和<code>resume</code>事件，可以了解网页何时进入/离开<code>Frozen</code>状态。</p><pre class="hljs"><code><span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'freeze'</span>, (event) =&gt; {
  <span class="hljs-comment">// The page is now frozen.</span>
});

<span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'resume'</span>, (event) =&gt; {
  <span class="hljs-comment">// The page has been unfrozen.</span>
});
</code></pre><h2 id="网页的卸载">网页的卸载 <a class="markdownIt-Anchor" href="#网页的卸载">#</a></h2><p>网页的卸载分成下面几种情况。</p><ol><li>Active / Passive 状态时，用户前往另一个网页，或关闭当前窗口。</li><li>Hidden 状态时，用户关闭窗口。</li><li>Hidden 状态时，网页被系统冻结（Frozen），进而可能被系统自动丢弃（Discarded）。</li></ol><p>第一种和第二种情况时，会触发<code>beforeunload</code>、<code>pagehide</code>和<code>unload</code>这三个事件，第三种情况会触发<code>freeze</code>事件。如果要确保代码在卸载时执行，不宜监听这些事件，因为没法保证所有情况下都会执行。尤其是<code>beforeunload</code>和<code>unload</code>还会阻止浏览器缓存当前网页，基本上，<code>beforeunload</code>只适用一种情况：提醒用户，修改表单后别忘了提交。</p><p>这时，可以监听到<code>visibilitychange</code>事件，把卸载时要执行的代码提前到变成<code>Hidden</code>状态时执行。</p><h2 id="documentwasdiscarded">document.wasDiscarded <a class="markdownIt-Anchor" href="#documentwasdiscarded">#</a></h2><p>网页处于 Hidden 状态时，当系统资源紧张，该网页可能会在用户没有感知的情况下，自动丢弃。举例来说，某个选项卡的标题，用户仍然能够看见，但网页已经被丢弃了。</p><p>这时，用户再次点击该选项卡的时候，浏览器会重新加载该网页。这时，开发者可以通过判断<code>document.wasDiscarded</code>属性，了解先前的网页是否被丢弃了。</p><pre class="hljs"><code><span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.wasDiscarded) {
  <span class="hljs-comment">// 不可见的网页已经被浏览器丢弃了</span>
}
</code></pre><h2 id="参考链接">参考链接 <a class="markdownIt-Anchor" href="#参考链接">#</a></h2><ul><li><a href="https://developers.google.com/web/updates/2018/07/page-lifecycle-api" target="_blank" rel="noopener">Page Lifecycle API</a>, Philip Walton</li></ul></article><nav class="level level-previous-next is-size-5 is-mobile"><!-- Left side --><div class="level-left"><p class="level-item is-narrow"><a href="intl-relativetimeformat.html"><span class="icon"><i class="fa fa-toggle-left"></i></span> Intl.RelativeTimeFormat</a></p></div><div class="level-right"><p class="level-item is-narrow"><a href="server-sent-events.html">Server-Sent Events <span class="icon"><i class="fa fa-toggle-right"></i></span></a></p></div></nav><div class="page-info is-size-5-desktop"><p>本教程采用<a href="https://creativecommons.org/licenses/by-sa/3.0/deed.zh" target="_blank">知识共享 署名-相同方式共享 3.0协议</a>。</p><p>最后生成于 2018-10-23 15:45:52</p><p>分享本文 <span class="social-share"></span></p></div></div><div class="column is-3 is-offset-1"><nav class="panel panel-menu"><p class="panel-heading"><i class="fa fa-book" aria-hidden="true"></i> Web API 教程</p><div class="panel-block"><aside class="menu"><p class="menu-label"></p><ul class="menu-list"><li><a href="canvas.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">Canvas API</span></a></li><li><a href="fontface.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">FontFace API</span></a></li><li><a href="geolocation.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">Geolocation API</span></a></li><li><a href="intersectionObserver.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">IntersectionObserver</span></a></li><li><a href="intl-relativetimeformat.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">Intl.RelativeTimeFormat</span></a></li><li><a href="page-lifecycle.html" class="is-active"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">Page Lifecycle API</span></a></li><li><a href="server-sent-events.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">Server-Sent Events</span></a></li><li><a href="svg.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">SVG 图像</span></a></li><li><a href="websocket.html"><span class="icon"></span> <i class="fa fa-file-text-o" aria-hidden="true" style="width: 14px;"></i> &nbsp; <span class="menu-list-title">WebSocket</span></a></li></ul></aside></div></nav><nav class="panel panel-info"><p class="panel-heading"><i class="fa fa-link" aria-hidden="true"></i> 链接</p><div class="panel-block"><aside class="menu"><p class="menu-label"></p><ul class="menu-list"><li><a href="https://raw.githubusercontent.com/wangdoc/webapi-tutorial/master/docs/page-lifecycle.md" target="_blank"><span class="icon"></span><i class="fa fa-code" aria-hidden="true" style="width: 14px;"></i>&nbsp;本文源码</a></li><li><a href="https://github.com/wangdoc/webapi-tutorial" target="_blank"><span class="icon"></span><i class="fa fa-hdd-o" aria-hidden="true" style="width: 14px;"></i>&nbsp;代码仓库</a></li><li><a href="https://github.com/wangdoc/webapi-tutorial/issues" target="_blank"><span class="icon"></span><i class="fa fa-flag-o" aria-hidden="true" style="width: 14px;"></i>&nbsp;反馈</a></li></ul></aside></div></nav></div></div><div class="columns"><div class="column is-8"><div id="disqus_thread"></div></div></div></div></section><footer class="footer is-size-5-desktop"><div class="container"><div class="content has-text-centered"><p>联系：contact@wangdoc.com</p></div></div></footer><script>var LOPPO={current_path:"page-lifecycle.md",relative_root_path:"",article_toc:'<ul class="markdownIt-TOC">\n<li><a href="#%E7%AE%80%E4%BB%8B">简介</a></li>\n<li><a href="#frozen-%E7%8A%B6%E6%80%81%E7%9A%84%E7%9B%91%E5%90%AC">Frozen 状态的监听</a></li>\n<li><a href="#%E7%BD%91%E9%A1%B5%E7%9A%84%E5%8D%B8%E8%BD%BD">网页的卸载</a></li>\n<li><a href="#documentwasdiscarded">document.wasDiscarded</a></li>\n<li><a href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">参考链接</a></li>\n</ul>\n'}</script><script src="assets/js/app.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111269443-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-111269443-1")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?5eec262881855af3dede6a71234571f6";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
const l = window.location;
const url = l.protocol + '//' + l.host + (l.port ? ':' + l.port : '') + l.pathname;
this.page.url = url;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = l.pathname; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://wangdoc-webapi.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script><!--script src="assets/js/social-share.min.js"--><!--/script--><script>var shareDesc="我正在阅读《Page Lifecycle API》，出自网道（WangDoc.com）的《Web API 教程》。",shareOpts={url:window.location.href,source:shareDesc,title:shareDesc,description:"",image:"",sites:["weibo","wechat","qq","qzone","twitter","facebook"],origin:"WangDoc_com",disabled:[],wechatQrcodeTitle:"微信",wechatQrcodeHelper:"扫一下二维码，分享到微信。"};socialShare(".social-share",shareOpts)</script></body></html>